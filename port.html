<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Portal</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
      :root {
        --primary: #4361ee;
        --secondary: #3f37c9;
        --success: #4cc9f0;
        --light: #f8f9fa;
        --dark: #212529;
        --gray: #6c757d;
        --border-radius: 12px;
        --box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --transition: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: var(--dark);
        background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        transition: var(--transition);
      }

      body[dir="rtl"] {
        font-family: "Tajawal", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .container {
        width: 100%;
        max-width: 1000px;
        margin: 20px auto;
        display: flex;
        flex-direction: column;
        gap: 30px;
      }

      .card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
        transition: var(--transition);
      }

      .card-header {
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        color: white;
        padding: 20px 30px;
        text-align: center;
      }

      .card-body {
        padding: 30px;
      }

      .logo {
        font-size: 2.2rem;
        margin-bottom: 15px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .card-title {
        font-size: 1.8rem;
        font-weight: 600;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--dark);
      }

      input,
      select {
        width: 100%;
        padding: 14px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: var(--transition);
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
      }

      .btn {
        display: inline-block;
        background: var(--primary);
        color: white;
        border: none;
        padding: 14px 25px;
        font-size: 1rem;
        font-weight: 500;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
        text-decoration: none;
      }

      .btn:hover {
        background: var(--secondary);
        transform: translateY(-2px);
      }

      .btn-block {
        display: block;
        width: 100%;
      }

      .btn-outline {
        background: transparent;
        border: 2px solid var(--primary);
        color: var(--primary);
      }

      .btn-outline:hover {
        background: var(--primary);
        color: white;
      }

      .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 500;
      }

      .alert-error {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        border: 1px solid #ef4444;
      }

      .alert-success {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
        border: 1px solid #22c55e;
      }

      .project-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .project-item {
        background: #f8fafc;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: var(--transition);
        border-left: 4px solid var(--primary);
      }

      .project-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .project-label {
        font-weight: 500;
        color: var(--gray);
        font-size: 0.9rem;
        margin-bottom: 5px;
        display: block;
      }

      .project-value {
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--dark);
      }

      .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
      }

      .status-active {
        background: rgba(34, 197, 94, 0.2);
        color: #16a34a;
      }

      .status-expired {
        background: rgba(239, 68, 68, 0.2);
        color: #dc2626;
      }

      .status-maintenance {
        background: rgba(245, 158, 11, 0.2);
        color: #d97706;
      }

      .project-url {
        color: var(--primary);
        text-decoration: none;
        word-break: break-all;
        display: block;
        margin-top: 5px;
        transition: var(--transition);
      }

      .project-url:hover {
        color: var(--secondary);
        text-decoration: underline;
      }

      .lang-switch {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        background: white;
        border: 1px solid #ddd;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: var(--transition);
      }

      .lang-switch:hover {
        transform: rotate(30deg);
      }

      .lang-switch i {
        font-size: 1.2rem;
        color: var(--primary);
      }

      .hidden {
        display: none;
      }

      footer {
        text-align: center;
        margin-top: 20px;
        color: var(--gray);
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .card-body {
          padding: 20px;
        }

        .card-header {
          padding: 15px 20px;
        }

        .logo {
          font-size: 1.8rem;
        }

        .card-title {
          font-size: 1.5rem;
        }

        .project-grid {
          grid-template-columns: 1fr;
        }

        .lang-switch {
          top: 15px;
          right: 15px;
          width: 45px;
          height: 45px;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 10px;
        }

        .container {
          margin: 10px auto;
        }

        .card-body {
          padding: 15px;
        }

        .form-group {
          margin-bottom: 15px;
        }

        input,
        select,
        .btn {
          padding: 12px;
        }
      }

      [dir="rtl"] {
        text-align: right;
        direction: rtl;
      }

      [dir="rtl"] .logo i {
        margin-left: 10px;
        margin-right: 0;
      }

      [dir="rtl"] .lang-switch {
        right: auto;
        left: 20px;
      }

      [dir="rtl"] .project-item {
        border-left: none;
        border-right: 4px solid var(--primary);
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 200px;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(67, 97, 238, 0.2);
        border-top: 5px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .config-warning {
        background-color: #fff8e1;
        border-left: 4px solid #ffc107;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
        font-size: 0.95rem;
      }
    </style>
  </head>
  <body>
    <div class="lang-switch" id="langSwitch">
      <i class="fas fa-language"></i>
    </div>

    <div class="container">
      <div id="loginPage" class="card">
        <div class="card-header">
          <div class="logo">
            <i class="fas fa-shield-alt"></i>
            <div class="card-title" data-i18n="loginTitle">
              Project Portal Login
            </div>
          </div>
        </div>
        <div class="card-body">
          <div id="loginAlert" class="alert hidden" role="alert"></div>

          <div class="config-warning hidden" id="configWarning">
            <strong>Configuration Required:</strong> Firebase is not configured.
            Replace the firebaseConfig object in the script with your Firebase
            project details.
          </div>

          <form id="loginForm">
            <div class="form-group">
              <label for="projectUrl" data-i18n="urlField">Project URL</label>
              <input
                type="url"
                id="projectUrl"
                placeholder="https://example.com"
                required
              />
            </div>

            <div class="form-group">
              <label for="projectId" data-i18n="idField">Project ID</label>
              <input
                type="text"
                id="projectId"
                placeholder="PROJ-123"
                required
              />
            </div>

            <button
              type="submit"
              class="btn btn-block"
              id="loginBtn"
              data-i18n="loginBtn"
            >
              <span id="loginBtnText">Login to Portal</span>
              <span id="loginSpinner" class="spinner hidden"></span>
            </button>
          </form>
        </div>
      </div>

      <div id="portalPage" class="card hidden">
        <div class="card-header">
          <div class="logo">
            <i class="fas fa-tachometer-alt"></i>
            <div class="card-title" data-i18n="portalTitle">
              Project Dashboard
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="alert alert-success" id="welcomeMessage">
            <span data-i18n="welcomeMessage">Welcome back,</span>
            <strong id="customerNameDisplay"></strong>!
          </div>

          <div id="portalContent">
            <div class="loading hidden">
              <div class="spinner"></div>
            </div>

            <div class="project-grid">
              <div class="project-item">
                <span class="project-label" data-i18n="customerName"
                  >Customer Name</span
                >
                <span class="project-value" id="customerName"></span>
              </div>

              <div class="project-item">
                <span class="project-label" data-i18n="projectId"
                  >Project ID</span
                >
                <span class="project-value" id="projectIdDisplay"></span>
              </div>

              <div class="project-item">
                <span class="project-label" data-i18n="projectName"
                  >Project Name</span
                >
                <span class="project-value" id="projectName"></span>
              </div>

              <div class="project-item">
                <span class="project-label" data-i18n="deploymentDate"
                  >Deployment Date</span
                >
                <span class="project-value" id="deploymentDate"></span>
              </div>

              <div class="project-item">
                <span class="project-label" data-i18n="supportEndDate"
                  >Support End Date</span
                >
                <span class="project-value" id="supportEndDate"></span>
              </div>

              <div class="project-item">
                <span class="project-label" data-i18n="supportStatus"
                  >Support Status</span
                >
                <span class="project-value">
                  <span id="supportStatus" class="status-badge"></span>
                </span>
              </div>

              <div class="project-item">
                <span class="project-label" data-i18n="projectStatus"
                  >Project Status</span
                >
                <span class="project-value">
                  <span id="projectStatus" class="status-badge"></span>
                </span>
              </div>

              <div class="project-item">
                <span class="project-label" data-i18n="projectUrl"
                  >Project URL</span
                >
                <a
                  href="#"
                  id="projectUrlLink"
                  class="project-url"
                  target="_blank"
                ></a>
              </div>
            </div>
          </div>

          <div style="margin-top: 30px; text-align: center">
            <button
              class="btn btn-outline"
              id="logoutBtn"
              data-i18n="logoutBtn"
            >
              <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p data-i18n="footerText">
        Project Portal System &copy; 2025 | Secure Cloud Management
      </p>
    </footer>

    <script>
      // ⚠️ IMPORTANT: REPLACE WITH YOUR ACTUAL FIREBASE CONFIG ⚠️
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
      };

      let db = null;

      // Wait for element to be available in DOM with timeout
      function waitForElement(id, timeout = 5000) {
        return new Promise((resolve) => {
          const startTime = Date.now();
          const checkInterval = setInterval(() => {
            const element = document.getElementById(id);
            if (element) {
              clearInterval(checkInterval);
              resolve(element);
            } else if (Date.now() - startTime > timeout) {
              clearInterval(checkInterval);
              resolve(null);
            }
          }, 100);
        });
      }

      // Parse URL parameters
      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          url: params.get('url'),
          id: params.get('id')
        };
      }

      // Auto-fill form from URL parameters
      async function autoFillFromUrlParams() {
        const params = getUrlParams();
        if (params.url || params.id) {
          const projectUrlEl = await waitForElement('projectUrl', 3000);
          const projectIdEl = await waitForElement('projectId', 3000);
          
          if (projectUrlEl && params.url) {
            projectUrlEl.value = params.url;
          }
          
          if (projectIdEl && params.id) {
            projectIdEl.value = params.id;
          }
          
          // Auto-submit if both parameters are present
          if (params.url && params.id) {
            setTimeout(() => {
              const loginForm = document.getElementById('loginForm');
              if (loginForm && !loginForm.querySelector('.spinner:not(.hidden)')) {
                loginForm.requestSubmit();
              }
            }, 300);
          }
        }
      }

      // Translation system
      const translations = {
        en: {
          loginTitle: "Project Portal Login",
          urlField: "Project URL",
          idField: "Project ID",
          loginBtn: "Login to Portal",
          portalTitle: "Project Dashboard",
          welcomeMessage: "Welcome back,",
          customerName: "Customer Name",
          projectId: "Project ID",
          projectName: "Project Name",
          deploymentDate: "Deployment Date",
          supportEndDate: "Support End Date",
          supportStatus: "Support Status",
          projectStatus: "Project Status",
          projectUrl: "Project URL",
          logoutBtn: "Logout",
          footerText: "Project Portal System &copy; 2025 | Secure Cloud Management",
          loginError: "Invalid URL or Project ID. Please try again.",
          loginSuccess: "Login successful! Redirecting to portal...",
          logoutSuccess: "You have been successfully logged out.",
          configNotice: "Configuration Required:",
          configMessage: "Firebase is not configured. Replace the firebaseConfig object in the script with your Firebase project details.",
          systemError: "System error: Please contact administrator.",
          firebaseError: "Firebase initialization failed. Please check configuration."
        },
        ar: {
          loginTitle: "تسجيل دخول بوابة المشروع",
          urlField: "رابط المشروع",
          idField: "معرف المشروع",
          loginBtn: "تسجيل الدخول للبوابة",
          portalTitle: "لوحة تحكم المشروع",
          welcomeMessage: "مرحباً بعودتك،",
          customerName: "اسم العميل",
          projectId: "معرف المشروع",
          projectName: "اسم المشروع",
          deploymentDate: "تاريخ النشر",
          supportEndDate: "تاريخ انتهاء الدعم",
          supportStatus: "حالة الدعم",
          projectStatus: "حالة المشروع",
          projectUrl: "رابط المشروع",
          logoutBtn: "تسجيل الخروج",
          footerText: "نظام بوابة المشروع &copy; 2025 | إدارة سحابية آمنة",
          loginError: "رابط أو معرف مشروع غير صالح. يرجى المحاولة مرة أخرى.",
          loginSuccess: "تم تسجيل الدخول بنجاح! جاري التوجيه إلى البوابة...",
          logoutSuccess: "تم تسجيل الخروج بنجاح.",
          configNotice: "الإعدادات مطلوبة:",
          configMessage: "Firebase غير مضبوط. استبدل كائن firebaseConfig في البرنامج النصي ببيانات مشروع Firebase الخاص بك.",
          systemError: "خطأ في النظام: يرجى الاتصال بالمسؤول.",
          firebaseError: "فشل تهيئة Firebase. يرجى التحقق من التهيئة."
        },
      };

      let currentLang = "en";

      // Initialize Firebase with error handling
      async function initFirebase() {
        try {
          // Check if config is valid
          if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
            throw new Error("Firebase configuration is missing. Please update the firebaseConfig object.");
          }
          
          // Wait for firebase script to be fully loaded
          if (typeof firebase === 'undefined') {
            console.warn("Firebase SDK not fully loaded yet. Waiting...");
            await new Promise(resolve => setTimeout(resolve, 500));
          }
          
          // Initialize Firebase
          firebase.initializeApp(firebaseConfig);
          db = firebase.firestore();
          console.log("✅ Firebase initialized successfully");
          return true;
        } catch (error) {
          console.error("❌ Firebase initialization failed:", error);
          
          // Show config warning
          const configWarning = await waitForElement("configWarning", 3000);
          if (configWarning) {
            configWarning.classList.remove("hidden");
          }
          
          return false;
        }
      }

      // Set language function
      async function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem("portalLang", lang);

        // Update all translatable elements
        document.querySelectorAll("[data-i18n]").forEach((element) => {
          const key = element.getAttribute("data-i18n");
          if (translations[lang][key]) {
            element.textContent = translations[lang][key];
          }
        });

        // Update login button text
        const loginBtnText = await waitForElement("loginBtnText", 2000);
        if (loginBtnText && translations[lang].loginBtn) {
          loginBtnText.textContent = translations[lang].loginBtn;
        }

        // Update logout button if exists
        const logoutBtn = await waitForElement("logoutBtn", 2000);
        if (logoutBtn && translations[lang].logoutBtn) {
          logoutBtn.innerHTML = `<i class="fas fa-sign-out-alt"></i> <span>${translations[lang].logoutBtn}</span>`;
        }

        // Update config warning if visible
        const configWarning = await waitForElement("configWarning", 2000);
        if (configWarning && !configWarning.classList.contains("hidden")) {
          configWarning.innerHTML = `<strong>${translations[lang].configNotice}</strong> ${translations[lang].configMessage}`;
        }

        // Set text direction
        document.documentElement.setAttribute("lang", lang);
        document.body.setAttribute("dir", lang === "ar" ? "rtl" : "ltr");

        // Update language switcher
        const langSwitch = await waitForElement("langSwitch", 2000);
        if (langSwitch) {
          langSwitch.innerHTML = `<i class="fas fa-language"></i> ${lang.toUpperCase()}`;
          langSwitch.setAttribute("aria-label", lang === "ar" ? "English" : "العربية");
        }
      }

      // Toggle language
      async function toggleLanguage() {
        const newLang = currentLang === "en" ? "ar" : "en";
        await setLanguage(newLang);
      }

      // Authentication functions
      async function handleLogin(e) {
        e.preventDefault();

        // Get all required elements with retry mechanism
        const projectUrlEl = await waitForElement('projectUrl', 3000);
        const projectIdEl = await waitForElement('projectId', 3000);
        const loginBtn = await waitForElement('loginBtn', 3000);
        const loginBtnText = await waitForElement('loginBtnText', 3000);
        const loginSpinner = await waitForElement('loginSpinner', 3000);
        const loginAlert = await waitForElement('loginAlert', 3000);
        
        // Validate all elements exist
        if (!projectUrlEl || !projectIdEl || !loginBtn || !loginBtnText || !loginSpinner || !loginAlert) {
          console.error("Required elements missing for login functionality");
          if (loginAlert) {
            loginAlert.textContent = translations[currentLang].systemError;
            loginAlert.className = "alert alert-error";
            loginAlert.classList.remove("hidden");
          }
          return;
        }

        const projectUrl = projectUrlEl.value.trim();
        const projectId = projectIdEl.value.trim().toUpperCase();

        // Validate inputs
        if (!projectUrl || !projectId) {
          loginAlert.textContent = translations[currentLang].loginError;
          loginAlert.className = "alert alert-error";
          loginAlert.classList.remove("hidden");
          return;
        }

        // Reset UI
        loginAlert.classList.add("hidden");
        loginBtn.disabled = true;
        loginBtnText.classList.add("hidden");
        loginSpinner.classList.remove("hidden");

        try {
          // Check if Firebase is initialized
          if (!db) {
            const firebaseInitialized = await initFirebase();
            if (!firebaseInitialized) {
              throw new Error(translations[currentLang].firebaseError);
            }
          }

          // Normalize URLs for comparison
          const normalizeUrl = (url) => {
            return url
              .replace(/^(https?:\/\/)?(www\.)?/, "")
              .replace(/\/$/, "")
              .toLowerCase();
          };

          const normalizedInputUrl = normalizeUrl(projectUrl);

          // Query Firestore securely
          const projectsRef = db.collection("projects");
          const snapshot = await projectsRef
            .where(firebase.firestore.FieldPath.documentId(), "==", projectId)
            .where("url", "==", normalizedInputUrl)
            .limit(1)
            .get();

          if (snapshot.empty) {
            throw new Error(translations[currentLang].loginError);
          }

          const doc = snapshot.docs[0];
          const data = doc.data();
          data.projectId = projectId; // Add projectId to data

          // Format dates if they're Firestore timestamps
          if (data.deploymentDate && data.deploymentDate.toDate) {
            data.deploymentDate = formatDate(data.deploymentDate.toDate());
          } else if (typeof data.deploymentDate === "string") {
            const date = new Date(data.deploymentDate);
            if (!isNaN(date.getTime())) {
              data.deploymentDate = formatDate(date);
            }
          }

          if (data.supportEndDate && data.supportEndDate.toDate) {
            data.supportEndDate = formatDate(data.supportEndDate.toDate());
          } else if (typeof data.supportEndDate === "string") {
            const date = new Date(data.supportEndDate);
            if (!isNaN(date.getTime())) {
              data.supportEndDate = formatDate(date);
            }
          }

          // Show success message
          loginAlert.textContent = translations[currentLang].loginSuccess;
          loginAlert.className = "alert alert-success";
          loginAlert.classList.remove("hidden");

          // Redirect to portal after delay
          setTimeout(() => {
            saveSession(data);
            showPortal(data);
          }, 1000);
        } catch (error) {
          console.error("Login error:", error);
          const errorMessage = error.message || translations[currentLang].loginError;
          loginAlert.textContent = errorMessage;
          loginAlert.className = "alert alert-error";
          loginAlert.classList.remove("hidden");
        } finally {
          loginBtn.disabled = false;
          loginBtnText.classList.remove("hidden");
          loginSpinner.classList.add("hidden");
        }
      }

      async function handleLogout() {
        localStorage.removeItem("portalSession");
        
        const loginPage = await waitForElement("loginPage", 2000);
        const portalPage = await waitForElement("portalPage", 2000);
        const loginForm = await waitForElement("loginForm", 2000);
        const loginAlert = await waitForElement("loginAlert", 2000);

        if (loginForm) loginForm.reset();
        if (portalPage) portalPage.classList.add("hidden");
        if (loginPage) loginPage.classList.remove("hidden");

        // Show success message
        if (loginAlert) {
          loginAlert.textContent = translations[currentLang].logoutSuccess;
          loginAlert.className = "alert alert-success";
          loginAlert.classList.remove("hidden");

          // Auto-hide after 3 seconds
          setTimeout(() => {
            if (loginAlert) loginAlert.classList.add("hidden");
          }, 3000);
        }
      }

      // UI functions
      async function showPortal(data) {
        // Get all required elements with retry
        const customerNameDisplay = await waitForElement("customerNameDisplay", 2000);
        const customerNameEl = await waitForElement("customerName", 2000);
        const projectIdDisplay = await waitForElement("projectIdDisplay", 2000);
        const projectNameEl = await waitForElement("projectName", 2000);
        const deploymentDateEl = await waitForElement("deploymentDate", 2000);
        const supportEndDateEl = await waitForElement("supportEndDate", 2000);
        const supportStatusEl = await waitForElement("supportStatus", 2000);
        const projectStatusEl = await waitForElement("projectStatus", 2000);
        const projectUrlLink = await waitForElement("projectUrlLink", 2000);
        const loginPage = await waitForElement("loginPage", 2000);
        const portalPage = await waitForElement("portalPage", 2000);
        
        // Customer name display
        if (customerNameDisplay) {
          customerNameDisplay.textContent = data.customerName || "Unknown Customer";
        }
        
        // Customer name field
        if (customerNameEl) {
          customerNameEl.textContent = data.customerName || "N/A";
        }
        
        // Project ID field
        if (projectIdDisplay) {
          projectIdDisplay.textContent = data.projectId || "N/A";
        }
        
        // Project name field
        if (projectNameEl) {
          projectNameEl.textContent = data.projectName || "N/A";
        }
        
        // Dates
        if (deploymentDateEl) {
          deploymentDateEl.textContent = data.deploymentDate || "N/A";
        }
        
        if (supportEndDateEl) {
          supportEndDateEl.textContent = data.supportEndDate || "N/A";
        }
        
        // Support status
        if (supportStatusEl) {
          supportStatusEl.textContent = data.supportStatus || "Unknown";
          supportStatusEl.className = "status-badge";
          
          if (["Active", "نشط"].includes(data.supportStatus)) {
            supportStatusEl.classList.add("status-active");
          } else if (["Expired", "منتهي"].includes(data.supportStatus)) {
            supportStatusEl.classList.add("status-expired");
          } else {
            supportStatusEl.classList.add("status-maintenance");
          }
        }
        
        // Project status
        if (projectStatusEl) {
          projectStatusEl.textContent = data.projectStatus || "Unknown";
          projectStatusEl.className = "status-badge";
          
          if (["Live", "نشط"].includes(data.projectStatus)) {
            projectStatusEl.classList.add("status-active");
          } else if (["Maintenance", "صيانة"].includes(data.projectStatus)) {
            projectStatusEl.classList.add("status-maintenance");
          } else {
            projectStatusEl.classList.add("status-expired");
          }
        }
        
        // Project URL
        const projectUrl = data.projectUrl || data.url || "#";
        if (projectUrlLink) {
          projectUrlLink.textContent = projectUrl !== "#" ? projectUrl : "N/A";
          projectUrlLink.href = projectUrl !== "#" ? projectUrl : "#";
        }

        // Show portal and hide login
        if (loginPage) loginPage.classList.add("hidden");
        if (portalPage) portalPage.classList.remove("hidden");
      }

      function saveSession(data) {
        const sessionData = {
          customerName: data.customerName || "Unknown Customer",
          projectId: data.projectId || "Unknown",
          projectName: data.projectName || "Unknown Project",
          deploymentDate: data.deploymentDate || "N/A",
          supportEndDate: data.supportEndDate || "N/A",
          supportStatus: data.supportStatus || "Unknown",
          projectStatus: data.projectStatus || "Unknown",
          projectUrl: data.projectUrl || data.url || "#",
        };

        localStorage.setItem("portalSession", JSON.stringify(sessionData));
      }

      // Utility functions
      function formatDate(date) {
        return new Date(date).toLocaleDateString(
          currentLang === "ar" ? "ar-EG" : "en-US",
          {
            year: "numeric",
            month: "short",
            day: "numeric",
          }
        );
      }

      // Check for existing session
      async function checkExistingSession() {
        const savedSession = localStorage.getItem("portalSession");
        if (savedSession && db) {
          try {
            showPortal(JSON.parse(savedSession));
          } catch (e) {
            console.error("Error parsing saved session:", e);
            localStorage.removeItem("portalSession");
          }
        }
      }

      // Main initialization function
      async function initApp() {
        try {
          // Initialize Firebase
          await initFirebase();
          
          // Initialize language
          const savedLang = localStorage.getItem("portalLang") || "en";
          await setLanguage(savedLang);
          
          // Auto-fill from URL parameters
          await autoFillFromUrlParams();
          
          // Setup event listeners
          const langSwitch = await waitForElement("langSwitch", 2000);
          const loginForm = await waitForElement("loginForm", 2000);
          const logoutBtn = await waitForElement("logoutBtn", 2000);
          
          if (langSwitch) {
            langSwitch.addEventListener("click", toggleLanguage);
          }
          
          if (loginForm) {
            loginForm.addEventListener("submit", handleLogin);
          }
          
          if (logoutBtn) {
            logoutBtn.addEventListener("click", handleLogout);
          }
          
          // Check for existing session
          await checkExistingSession();
          
        } catch (error) {
          console.error("Application initialization error:", error);
        }
      }

      // Start the application after DOM is fully loaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initApp);
      } else {
        initApp();
      }
    </script>
  </body>
</html>
