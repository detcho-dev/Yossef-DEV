<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --border-radius: 12px;
      --box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .container { width: 100%; max-width: 1000px; margin: 20px auto; }
    .card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
    }

    .card-header {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      padding: 20px 30px;
      text-align: center;
    }

    .card-body { padding: 30px; }

    .logo { font-size: 2rem; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .card-title { font-size: 1.8rem; font-weight: 600; }

    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); }
    input {
      width: 100%;
      padding: 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    .btn {
      display: block;
      width: 100%;
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px;
      font-size: 1rem;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 500;
    }

    .alert-error { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .alert-success { background: rgba(34, 197, 94, 0.15); color: #22c55e; }

    .project-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .project-item {
      background: #f8fafc;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .project-label {
      font-weight: 500;
      color: var(--gray);
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .project-value { font-weight: 600; font-size: 1.1rem; }

    /* Status Dot */
    .status-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 8px;
      vertical-align: middle;
    }

    .status-live .status-dot { background-color: #4caf50; }
    .status-developing .status-dot { background-color: #ff9800; }
    .status-closed .status-dot { background-color: #9e9e9e; }
    .status-fixing .status-dot { background-color: #f44336; }

    .hidden { display: none; }

    /* Demo mode warning */
    .demo-warning {
      background: #fff8e1;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Form -->
    <div id="loginPage" class="card">
      <div class="card-header">
        <div class="logo">
          <i class="fas fa-shield-alt"></i>
          <div class="card-title">Project Portal Login</div>
        </div>
      </div>
      <div class="card-body">
        <div id="loginAlert" class="alert hidden"></div>
        
        <div class="demo-warning" id="demoWarning">
          <strong>Demo Mode:</strong> Use URL: <code>https://example.com</code> and ID: <code>DEMO123</code>
        </div>

        <form id="loginForm">
          <div class="form-group">
            <label for="projectUrl">Project URL</label>
            <input type="url" id="projectUrl" placeholder="https://example.com" required />
          </div>
          <div class="form-group">
            <label for="projectId">Project ID</label>
            <input type="text" id="projectId" placeholder="DEMO123" required />
          </div>
          <button type="submit" class="btn" id="loginBtn">Login to Portal</button>
        </form>
      </div>
    </div>

    <!-- Portal Dashboard -->
    <div id="portalPage" class="card hidden">
      <div class="card-header">
        <div class="logo">
          <i class="fas fa-tachometer-alt"></i>
          <div class="card-title">Project Dashboard</div>
        </div>
      </div>
      <div class="card-body">
        <div class="alert alert-success" id="welcomeMessage">
          Welcome back, <strong id="customerNameDisplay"></strong>!
        </div>

        <div class="project-grid">
          <div class="project-item">
            <span class="project-label">Customer Name</span>
            <span class="project-value" id="customerName"></span>
          </div>
          <div class="project-item">
            <span class="project-label">Project ID</span>
            <span class="project-value" id="projectIdDisplay"></span>
          </div>
          <div class="project-item">
            <span class="project-label">Project Name</span>
            <span class="project-value" id="projectName"></span>
          </div>
          <div class="project-item">
            <span class="project-label">Deployment Date</span>
            <span class="project-value" id="deploymentDate"></span>
          </div>
          <div class="project-item">
            <span class="project-label">Support End Date</span>
            <span class="project-value" id="supportEndDate"></span>
          </div>
          <div class="project-item">
            <span class="project-label">Project Status</span>
            <span class="project-value" id="projectStatus"></span>
          </div>
          <div class="project-item">
            <span class="project-label">Project URL</span>
            <a href="#" id="projectUrlLink" target="_blank" class="project-value"></a>
          </div>
          <div class="project-item">
            <span class="project-label">Support Status</span>
            <span class="project-value" id="supportStatus"></span>
          </div>
        </div>

        <button class="btn" style="background:#6c757d;margin-top:30px;" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // ðŸ”‘ YOUR FIREBASE CONFIG (Replace with yours)
    const firebaseConfig = {
      apiKey: "AIzaSyAemoGMX1PHF55qUTh_5SZIrN3Y-QaqrWA",
      authDomain: "yossef-dev-216b0.firebaseapp.com",
      projectId: "yossef-dev-216b0",
      storageBucket: "yossef-dev-216b0.firebasestorage.app",
      messagingSenderId: "509948939620",
      appId: "1:509948939620:web:017b806e995bb114d8be71"
    };

    // DOM Elements (safe references)
    const loginPage = document.getElementById('loginPage');
    const portalPage = document.getElementById('portalPage');
    const loginForm = document.getElementById('loginForm');
    const loginAlert = document.getElementById('loginAlert');
    const demoWarning = document.getElementById('demoWarning');

    // Initialize app when page is fully loaded
    window.addEventListener('load', () => {
      // Auto-fill from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const url = urlParams.get('url');
      const id = urlParams.get('id');
      
      if (url && id) {
        document.getElementById('projectUrl').value = url;
        document.getElementById('projectId').value = id;
        
        // Auto-login in demo mode
        if (url === 'https://example.com' && id === 'DEMO123') {
          setTimeout(() => loginForm.requestSubmit(), 500);
        }
      }
    });

    // Smart support date formatter
    function formatSupportDate(endDateStr) {
      if (!endDateStr || endDateStr.trim().toLowerCase() === 'un') {
        return 'Unlimited Support';
      }

      // Handle DD-MM-YYYY format
      let date;
      if (endDateStr.includes('-')) {
        const [d, m, y] = endDateStr.split('-');
        date = new Date(`${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`);
      } else {
        date = new Date(endDateStr);
      }

      if (isNaN(date.getTime())) return endDateStr;

      const now = new Date();
      const diffDays = Math.ceil((date - now) / (1000 * 60 * 60 * 24));

      if (diffDays > 7) return date.toLocaleDateString('en-GB');
      if (diffDays > 0) return `Ends in ${diffDays} day${diffDays !== 1 ? 's' : ''}`;
      if (diffDays === 0) return 'Ends today';
      return `Ended ${Math.abs(diffDays)} day${Math.abs(diffDays) !== 1 ? 's' : ''} ago`;
    }

    // Format project status with dot
    function formatProjectStatus(status) {
      let dotClass = '';
      let displayText = status || 'Unknown';

      if (status === 'Live') {
        dotClass = 'status-live';
      } else if (status === 'Under Development') {
        dotClass = 'status-developing';
        displayText = 'Under Development';
      } else if (status === 'Closed') {
        dotClass = 'status-closed';
      } else if (status === 'Fixing Bugs') {
        dotClass = 'status-fixing';
        displayText = 'Fixing Bugs';
      }

      return `<span class="${dotClass}">${displayText}<span class="status-dot"></span></span>`;
    }

    // Login Handler
    loginForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const projectUrl = document.getElementById('projectUrl').value.trim();
      const projectId = document.getElementById('projectId').value.trim();

      // Demo mode check
      if (projectUrl === 'https://example.com' && projectId === 'DEMO123') {
        showDemoPortal();
        return;
      }

      // Real mode - initialize Firebase
      try {
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Normalize URL for comparison
        const normalizeUrl = (url) => url.replace(/^(https?:\/\/)?(www\.)?/, '').replace(/\/$/, '').toLowerCase();
        const normalizedUrl = normalizeUrl(projectUrl);

        // Query Firestore
        const snapshot = await db
          .collection('projects')
          .where(firebase.firestore.FieldPath.documentId(), '==', projectId)
          .get();

        if (snapshot.empty) throw new Error('Invalid Project ID');
        
        const doc = snapshot.docs[0];
        const data = doc.data();
        
        // Verify URL matches
        if (normalizeUrl(data.url) !== normalizedUrl) {
          throw new Error('URL does not match Project ID');
        }

        // Add projectId to data
        data.projectId = projectId;
        
        // Show portal
        showPortal(data);
      } catch (error) {
        loginAlert.textContent = error.message || 'Login failed. Please check your credentials.';
        loginAlert.className = 'alert alert-error';
        loginAlert.classList.remove('hidden');
      }
    });

    // Show Demo Data
    function showDemoPortal() {
      const demoData = {
        customerName: "Demo Customer",
        projectId: "DEMO123",
        projectName: "Example Project",
        deploymentDate: "Jan 15, 2023",
        supportEndDate: "un",
        projectStatus: "Live",
        supportStatus: "Active",
        url: "https://example.com"
      };
      showPortal(demoData);
    }

    // Show Real Portal
    function showPortal(data) {
      // Fill customer name
      document.getElementById('customerNameDisplay').textContent = data.customerName;
      document.getElementById('customerName').textContent = data.customerName;
      
      // Fill other fields
      document.getElementById('projectIdDisplay').textContent = data.projectId;
      document.getElementById('projectName').textContent = data.projectName;
      document.getElementById('deploymentDate').textContent = data.deploymentDate || 'N/A';
      document.getElementById('supportEndDate').textContent = formatSupportDate(data.supportEndDate);
      document.getElementById('projectStatus').innerHTML = formatProjectStatus(data.projectStatus);
      document.getElementById('supportStatus').textContent = data.supportStatus || 'N/A';
      
      // Fill URL
      const urlEl = document.getElementById('projectUrlLink');
      urlEl.textContent = data.url;
      urlEl.href = data.url;
      
      // Switch views
      loginPage.classList.add('hidden');
      portalPage.classList.remove('hidden');
    }

    // Logout
    document.getElementById('logoutBtn')?.addEventListener('click', () => {
      portalPage.classList.add('hidden');
      loginPage.classList.remove('hidden');
      loginForm.reset();
    });
  </script>
</body>
</html>
